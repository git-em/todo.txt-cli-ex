#!/bin/bash
# 2009 Matt Brubeck
# License:  GPL, http://www.gnu.org/copyleft/gpl.html

action=$1
shift

[ "$action" = "usage" ] && { 
    echo "    $(basename $0) [ITEM#] [SRC]"
    echo "      Open ITEM# in \$TODO_DIR/SRC in \$EDITOR for editing."
    echo "      If ITEM# is omitted, the entire file is edited."
    echo "      If BASENAME is not given, defaults to 'todo'."
    echo "      ITEM# can be removed by deleting the line."
    echo "      Additional tasks can be added by appending more lines."
    echo ""
    exit
}

item=
if [[ "$1" =~ ^[0-9]+$ ]]; then
    # We got an ITEM#. 
    item=$1
    shift
fi
FILE=$TODO_DIR/${1:-todo}.txt

if [ ! "$item" ]; then
    # Edit entire file. 
    exec "$EDITOR" "$FILE"
fi


# Edit single task. 

TMPEDIT="${TEMP:-/tmp}/todo-edit.$$.txt"
EDITME=$(sed -e "$item!d" "$FILE")
[ -z "$EDITME" ] && die "TODO: No task $item." 
echo "$EDITME" > "$TMPEDIT"

TMPMODTIME=$(stat -c %Y "$TMPEDIT")
"$EDITOR" "$TMPEDIT" || { echo 2>&1 "Unclean exit of editor; aborting!"; exit $?; }
NEWMODTIME=$(stat -c %Y "$TMPEDIT")

if [ $NEWMODTIME -eq $TMPMODTIME ]; then
    echo "No changes done."
    exit 0
fi

newContent=$(head -n 1 "$TMPEDIT")
if [ -z "$newContent" ]; then
    # We don't need to ask for confirmation here, the "del" command will take
    # care of that. 
    "$TODO_FULL_SH" command del $item
elif [ "$newContent" = "$EDITME" ]; then
    echo "No changes done to original line."
else
    # The 'replace' command doesn't handle done tasks, and may do
    # surprising things to existing priorities and dates. To avoid surprises,
    # do the complete replacement of the line here. 
    newContent=$(echo "$newContent" | sed 's/\&/\\\&/g')
    sed -i.bak "$item s|^.*|${newContent}|" "$TODO_FILE"
    echo "$item $EDITME"
    echo "TODO: Replaced task with:"
    echo "$item $newContent"
fi

newLinesNum=$(sed '1d' "$TMPEDIT" | grep -cve '^\s*$')
if [ $newLinesNum -ge 1 ]; then
    if  [ $TODOTXT_FORCE = 0 ]; then
        echo
        if [ $newLinesNum -eq 1 ]; then
            echo "There is one additional line. Add it as another task? (y/n)"
        else
            echo "There are $newLinesNum additional lines. Add them as individual tasks? (y/n)"
        fi
        read ANSWER
    else
        ANSWER="y"
    fi
    if [ "$ANSWER" = "y" ]; then
        IFS=$'\n'
        sed -e '1d' -e '/^[ \t]*$/d' "$TMPEDIT" | while IFS=$'\n' read newtask
        do
            # -T: The additional lines should be added as-is, without TODOTXT_DATE_ON_ADD. 
            "$TODO_FULL_SH" -T command add "$newtask"
        done
    fi
fi
