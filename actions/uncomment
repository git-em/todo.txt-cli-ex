#!/bin/bash

action=$1
shift

[ "$action" = "usage" ] && {
    echo "    $(basename $0) [-q] ITEM#"
    echo "      Removes the done / trashed comment on task ITEM#."
    echo ""
    exit
}

errmsg="usage: $TODO_SH $(basename $0) [-q] ITEM#"

: ${TODOTXT_COMMENT_SYMBOL:= => }

isSilentAndQuery=
if [ "$1" = '-q' ]; then
    isSilentAndQuery='true'
    shift
fi
item=$1; shift

getTodo "$item"
newtodo=${todo%%${TODOTXT_COMMENT_SYMBOL}*}
if [ "$isSilentAndQuery" ]; then
    [ "$newtodo" = "$todo" ] && exit 0
    comment=${todo#*${TODOTXT_COMMENT_SYMBOL}}
    if [ "$comment" ]; then
        read -p "Remove comment \"${comment}\"? (y/n) " answer
    else
        read -p "Remove empty comment? (y/n) " answer
    fi

    [ "$answer" = 'y' ] || exit 0
fi

[ "$newtodo" ] || die "TODO: Removal of comment would create empty task."

if [ "$newtodo" = "$todo" ]; then
    [ $TODOTXT_VERBOSE -gt 0 ] && echo "$item $todo"
    die "TODO: Task $item does not contain a comment."
fi
"$TODO_FULL_SH" command replace $item "$newtodo"
