#!/usr/bin/env bash

action=$1
shift
item=$1
shift
param="$*"

pattern=" t:\([0-9]\{2,4\}[^A-Za-z0-9]\)\{2\}[0-9]\{2,4\}" # not enforcing any particular format

function usage {
	echo "    $(basename $0) [ITEM# DATE|ITEM# del|ITEM# rm]"
	echo "      Set, change or remove date threshold of an item."
	echo "      If arguments are omitted, all scheduled tasks are listed."
	echo "      Intended to be used with futureTasks "
	echo "      (http://github.com/FND/todo.txt-cli/blob/extensions/futureTasks)."
	echo "      Example: $ $TODO_SH $(basename $0) 42 tomorrow"
	echo ""
	exit
}

function list {
	$TODO_FULL_SH -x list | sed -ne "/$pattern/p"
}

function remove {
	item=$1
	verbose=$TODOTXT_VERBOSE
	TODOTXT_VERBOSE=0
	task=$($TODO_FULL_SH -x -p list $item | tail -n1 | sed \
		-e "s/$pattern//" \
		-e "s/^[0-9]* //" \
		-e "s/^([A-Z])* //") # remove threshold, item number and priority
	TODOTXT_VERBOSE=$verbose
	$TODO_FULL_SH replace $item "$task" # N.B.: retains priority
}

function replace {
	item=$1
	threshold=$2

	verbose=$TODOTXT_VERBOSE
	TODOTXT_VERBOSE=0
	task=$($TODO_FULL_SH -x -p list $item | tail -n1 | sed \
		-e "s/$pattern//" \
		-e "s/^[0-9]* //" \
		-e "s/^([A-Z])* //") # remove threshold, item number and priority
	TODOTXT_VERBOSE=$verbose
	$TODO_FULL_SH replace $item "$task t:"`date -d "$threshold" +%F`
}

[ "$action" = "usage" ] && usage

if [ -z $item ]; then
	list
elif [ "$param" = "del" -o "$param" = "rm" ]; then
	remove $item
else
	replace $item "$param"
fi
